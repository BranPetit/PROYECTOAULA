@page "/"
@rendermode InteractiveServer
@using FrontendBlazorApi.Servicios
@inject NavigationManager navegador
@inject ServicioAutenticacion servicioAuth
@inject ServicioApiGenerico servicioApi

<PageTitle>Inicio de Sesión</PageTitle>

<style>
    body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, sans-serif;
    }

    .login-bg {
        height: 100vh;
        width: 100%;
        background: radial-gradient(circle at top left, #ddebff, #b5d0ff 60%, #8cb3ff);
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        position: relative;
    }

    /* Círculos decorativos SIN animación */
    .circle {
        position: absolute;
        border-radius: 50%;
        filter: blur(80px);
        opacity: 0.55;
    }

    .circle1 {
        width: 380px;
        height: 380px;
        background: #7aa8ff;
        top: -80px;
        left: -50px;
    }

    .circle2 {
        width: 320px;
        height: 320px;
        background: #5cb4ff;
        bottom: -90px;
        right: -30px;
    }

    .circle3 {
        width: 260px;
        height: 260px;
        background: #4d9fff;
        top: 40%;
        left: 70%;
    }

    /* Tarjeta principal */
    .login-card {
        width: 100%;
        max-width: 900px;
        display: flex;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 22px;
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.45);
        padding: 45px;
        color: black;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.20);
    }

    /* Columnas */
    .login-info {
        flex: 1;
        padding-right: 40px;
        border-right: 1px solid rgba(0,0,0,0.15);
    }

        .login-info h2 {
            font-size: 2.4rem;
            font-weight: 700;
        }

        .login-info p {
            opacity: 0.85;
            font-size: 1.1rem;
            margin-bottom: 25px;
        }

    .info-bullet {
        margin-top: 12px;
        display: flex;
        align-items: center;
        font-size: 1.05rem;
    }

        .info-bullet i {
            color: #005eff;
            margin-right: 10px;
            font-size: 1.2rem;
        }

    /* Formulario */
    .login-form {
        flex: 1;
        padding-left: 40px;
    }

    .login-title {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 5px;
        color: black;
    }

    .login-subtitle {
        opacity: 0.85;
        margin-bottom: 30px;
        color: black;
    }

    .input-group-login {
        position: relative;
        margin-bottom: 25px;
    }

    .input-icon {
        position: absolute;
        top: 50%;
        left: 15px;
        transform: translateY(-50%);
        font-size: 1.3rem;
        color: #005eff;
    }

    .login-input {
        width: 100%;
        height: 55px;
        border-radius: 14px;
        background: white;
        border: 1px solid #bcd3ff;
        padding-left: 50px;
        color: black;
        font-size: 1rem;
    }

        .login-input:focus {
            outline: none;
            border-color: #005eff;
            box-shadow: 0 0 10px rgba(0, 94, 255, 0.35);
        }

    /* Botón */
    .btn-login {
        width: 100%;
        height: 55px;
        border-radius: 14px;
        background: #005eff;
        color: white;
        font-size: 1.2rem;
        font-weight: 600;
        border: none;
        transition: 0.2s ease;
    }

        .btn-login:hover {
            transform: translateY(-2px);
            background: #0047c2;
        }

    /* Alertas */
    .alert-modern {
        background: rgba(255, 0, 0, 0.15);
        border-left: 6px solid #ff3f3f;
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 20px;
        color: #b30000;
        font-weight: 600;
    }

</style>



<div class="login-bg">
    <div class="circle circle1"></div>
    <div class="circle circle2"></div>
    <div class="circle circle3"></div>

    <div class="login-card">

        <!-- IZQUIERDA -->
        <div class="login-info">
            <h2>Bienvenido</h2>
            <p>Sistema Integral de Gestión de Proyectos</p>

            <div class="info-bullet"><i class="bi bi-kanban-fill"></i> Planeación estratégica de proyectos</div>
            <div class="info-bullet"><i class="bi bi-bar-chart-fill"></i> Seguimiento con paneles dinámicos</div>
            <div class="info-bullet"><i class="bi bi-people-fill"></i> Gestión de roles y equipos</div>
            <div class="info-bullet"><i class="bi bi-clock-history"></i> Control de tiempos y actividades</div>
            <div class="info-bullet"><i class="bi bi-folder-check"></i> Administración de documentación</div>
        </div>

        <!-- FORMULARIO -->
        <div class="login-form">
            <div class="login-title">Iniciar Sesión</div>
            <div class="login-subtitle">Ingrese sus credenciales para continuar</div>

            @if (!string.IsNullOrEmpty(mensaje))
            {
                <div class="alert-modern">
                    <i class="bi bi-exclamation-circle me-2"></i>@mensaje
                </div>
            }

            <EditForm Model="credenciales" OnValidSubmit="IniciarSesion">
                <DataAnnotationsValidator />

                <div class="input-group-login">
                    <i class="bi bi-person-fill input-icon"></i>
                    <InputText class="login-input"
                               @bind-Value="credenciales.Usuario"
                               placeholder="Correo electrónico" />
                </div>

                <div class="input-group-login">
                    <i class="bi bi-lock-fill input-icon"></i>
                    <InputText type="password"
                               class="login-input"
                               @bind-Value="credenciales.Contrasena"
                               placeholder="Contraseña" />
                </div>

                <button type="submit" class="btn-login" disabled="@cargando">
                    @if (cargando)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                        mensaje = "Verificando credenciales...";
                    }
                    else
                    {
                        <span>Ingresar</span>
                    }
                </button>
            </EditForm>
        </div>
    </div>
</div>


@code {
    private Credenciales credenciales = new();
    private string mensaje = "";
    private string claseAviso = "alert-info";
    private string iconoMensaje = "bi-info-circle";
    private bool cargando = false;

    private async Task IniciarSesion()
    {
        try
        {
            cargando = true;
            MostrarMensaje("Verificando credenciales...", "info");

            // 1. Obtener token usando ServicioApiGenerico
            var datosToken = new
            {
                Tabla = "usuario",
                CampoUsuario = "email",
                CampoContrasena = "contrasena",
                Usuario = credenciales.Usuario,
                Contrasena = credenciales.Contrasena
            };

            var resultado = await servicioApi.PostAsync<RespuestaToken>("api/Autenticacion/token", datosToken);

            if (resultado == null || string.IsNullOrEmpty(resultado.Token))
            {
                MostrarMensaje("No se recibió un token válido del servidor", "warning");
                return;
            }

            // 2. Guardar token en ServicioAutenticacion
            await servicioAuth.IniciarSesionAsync(resultado.Token, credenciales.Usuario);

            // 3. Cargar TODAS las rutas de TODOS los roles del usuario que hizo login
            try
            {
                // Obtener todos los rol_usuario y filtrar por email
                var todosRolUsuario = await servicioApi.ObtenerTodosAsync<RolUsuario>("Rol_Usuario");
                var rolesDelUsuario = todosRolUsuario?.Where(ru => ru.FkEmail == credenciales.Usuario).ToList();

                if (rolesDelUsuario != null && rolesDelUsuario.Count > 0)
                {
                    // Obtener todos los roles
                    var todosRoles = await servicioApi.ObtenerTodosAsync<Rol>("rol");

                    // Obtener nombres de los roles del usuario
                    var nombresRolesUsuario = rolesDelUsuario
                        .Select(ru => todosRoles?.FirstOrDefault(r => r.IdRol == ru.FkIdRol)?.Nombre)
                        .Where(nombre => !string.IsNullOrEmpty(nombre))
                        .ToList();

                    if (nombresRolesUsuario.Count > 0)
                    {
                        // Obtener TODAS las rutasrol y filtrar por TODOS los roles del usuario
                        var todasRutasRol = await servicioApi.ObtenerTodosAsync<RutaRol>("RutaRol");
                        var rutasDelUsuario = todasRutasRol?
                            .Where(rr => nombresRolesUsuario.Contains(rr.NombreRol))
                            .Distinct()
                            .ToList();

                        if (rutasDelUsuario != null && rutasDelUsuario.Count > 0)
                        {
                            await servicioAuth.GuardarRutasRolAsync(rutasDelUsuario);
                        }
                    }
                }
            }
            catch
            {
                // Si falla cargar permisos, continuar igual
            }

            MostrarMensaje("¡Inicio de sesión exitoso! Redirigiendo...", "success");
            await Task.Delay(1500);
            navegador.NavigateTo("/home", forceLoad: true);
        }
        catch (Exception ex)
        {
            MostrarMensaje($"Error: {ex.Message}", "danger");
        }
        finally
        {
            cargando = false;
        }
    }

    private void MostrarMensaje(string texto, string tipo)
    {
        mensaje = texto;
        claseAviso = tipo switch
        {
            "success" => "alert-success",
            "danger" => "alert-danger",
            "warning" => "alert-warning",
            _ => "alert-info"
        };
        iconoMensaje = tipo switch
        {
            "success" => "bi-check-circle-fill",
            "danger" => "bi-exclamation-triangle-fill",
            "warning" => "bi-exclamation-circle-fill",
            _ => "bi-info-circle-fill"
        };
    }

    private class Credenciales
    {
        public string Usuario { get; set; } = "";
        public string Contrasena { get; set; } = "";
    }

    private class RespuestaToken
    {
        public string? Token { get; set; }
    }

    private class RespuestaConsulta
    {
        public List<Dictionary<string, object>>? Resultados { get; set; }
    }

    private class RolUsuario
    {
        [System.Text.Json.Serialization.JsonPropertyName("fkemail")]
        public string? FkEmail { get; set; }

        [System.Text.Json.Serialization.JsonPropertyName("fkidrol")]
        public int FkIdRol { get; set; }
    }

    private class Rol
    {
        [System.Text.Json.Serialization.JsonPropertyName("id")]
        public int IdRol { get; set; }

        [System.Text.Json.Serialization.JsonPropertyName("nombre")]
        public string? Nombre { get; set; }
    }

    // Métodos auxiliares para extraer valores de Dictionary
    private int ObtenerInt(Dictionary<string, object> dict, string key)
    {
        if (dict.TryGetValue(key, out var valor) && valor != null)
        {
            if (valor is int i) return i;
            if (int.TryParse(valor.ToString(), out var resultado)) return resultado;
        }
        return 0;
    }

    private string ObtenerString(Dictionary<string, object> dict, string key)
    {
        if (dict.TryGetValue(key, out var valor) && valor != null)
            return valor.ToString() ?? "";
        return "";
    }
}