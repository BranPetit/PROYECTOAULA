@page "/calendario"
@inject IHttpClientFactory fabricaHttp

<h3>Calendario de Proyectos</h3>

@if (error != null)
{
    <div class="alert alert-danger">@error</div>
}
else if (proyectos == null)
{
    <p>Cargando...</p>
}
else
{
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Título</th>
                <th>Fecha Inicio</th>
                <th>Fecha Fin Prevista</th>
                <th>Fecha Finalización</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var p in proyectos)
            {
                <tr>
                    <td>@p.Titulo</td>
                    <td>@p.FechaInicio?.ToString("yyyy-MM-dd")</td>
                    <td>@p.FechaFinPrevista?.ToString("yyyy-MM-dd")</td>
                    <td>@p.FechaFinalizacion?.ToString("yyyy-MM-dd")</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {

    private string? error;
    private List<Proyecto>? proyectos;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var cliente = fabricaHttp.CreateClient("ApiProyecto");

            // 🔵 PREPARA LA CONSULTA PARA ConsultasController
            var cuerpo = new
            {
                consulta = @"
                    SELECT
                        Id AS Id,
                        Titulo AS Titulo,
                        FechaInicio AS FechaInicio,
                        FechaFinPrevista AS FechaFinPrevista,
                        FechaFinalizacion AS FechaFinalizacion
                    FROM Proyecto
                    ORDER BY FechaInicio DESC
                ",
                parametros = new { }     // no hay parámetros
            };

            // 🔵 POST → /api/consultas/ejecutarconsultaparametrizada
            var resp = await cliente.PostAsJsonAsync(
                "api/consultas/ejecutarconsultaparametrizada",
                cuerpo
            );

            if (!resp.IsSuccessStatusCode)
            {
                error = $"Error al listar: {resp.StatusCode}";
                return;
            }

            // La respuesta tiene estructura:
            // { resultados: List<Dictionary>, total: N }
            var json = await resp.Content.ReadFromJsonAsync<RespuestaConsultas>();

            if (json?.Resultados == null)
            {
                error = "No se recibieron datos.";
                return;
            }

            // 🔵 Convertimos los diccionarios a tu modelo Proyecto
            proyectos = json.Resultados.Select(r => new Proyecto
            {
                Id = Convert.ToInt32(r["Id"]),
                Titulo = r["Titulo"]?.ToString(),
                FechaInicio = r["FechaInicio"] as DateTime?,
                FechaFinPrevista = r["FechaFinPrevista"] as DateTime?,
                FechaFinalizacion = r["FechaFinalizacion"] as DateTime?
            }).ToList();
        }
        catch (Exception ex)
        {
            error = "Error al cargar calendario: " + ex.Message;
        }
    }

    // ----------------------------- MODELOS -----------------------------

    public class Proyecto
    {
        public int Id { get; set; }
        public string? Titulo { get; set; }
        public DateTime? FechaInicio { get; set; }
        public DateTime? FechaFinPrevista { get; set; }
        public DateTime? FechaFinalizacion { get; set; }
    }

    public class RespuestaConsultas
    {
        public List<Dictionary<string, object?>>? Resultados { get; set; }
        public int Total { get; set; }
        public string? Advertencia { get; set; }
    }
}
