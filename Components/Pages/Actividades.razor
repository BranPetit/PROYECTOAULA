@page "/Actividades"
@using System.Net.Http.Json
@using System.ComponentModel.DataAnnotations
@using FrontendBlazorApi.Models
@inject IHttpClientFactory fabricaHttp
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>Gestión de Actividades</PageTitle>

<div class="container mt-4"> <div class="card shadow-sm"> <div class="card-header bg-primary text-white d-flex align-items-center justify-content-between"> <h4 class="mb-0"><i class="bi bi-clipboard2-check me-2"></i>Gestión de Actividades</h4> <div> <button type="button" class="btn btn-light btn-sm me-2" title="Probar conexión" @onclick="ProbarConexion"> <i class="bi bi-plug"></i> </button> <button type="button" class="btn btn-light btn-sm me-2" title="Mostrar todos" @onclick="CargarItems"> <i class="bi bi-list-task"></i> </button> <button type="button" class="btn btn-light btn-sm" title="Limpiar formulario" @onclick="LimpiarFormulario"> <i class="bi bi-eraser"></i> </button> </div> </div>
    <div class="card-body">
        <!-- Buscador -->
        <div class="input-group mb-3">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <InputNumber class="form-control" placeholder="Ingrese ID de la Actividad" @bind-Value="idBusqueda" />
            <button type="button" class="btn btn-outline-primary" @onclick="BuscarPorId">Buscar</button>
        </div>

        <!-- Mensajes -->
        @if (!string.IsNullOrWhiteSpace(mensaje))
        {
            <div class="@claseAviso" role="alert">@mensaje</div>
        }

        <!-- Formulario -->
        <EditForm Model="itemActual" OnValidSubmit="GuardarSegunEstado">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Id Entregable *</label>
                    <InputNumber class="form-control" @bind-Value="itemActual.IdEntregable" />
                    <ValidationMessage For="@(() => itemActual.IdEntregable)" />
                </div>

                <div class="col-md-6">
                    <label class="form-label">Título *</label>
                    <InputText class="form-control" @bind-Value="itemActual.Titulo" />
                    <ValidationMessage For="@(() => itemActual.Titulo)" />
                </div>

                <div class="col-md-12">
                    <label class="form-label">Descripción</label>
                    <InputTextArea class="form-control" @bind-Value="itemActual.Descripcion" />
                </div>

                <div class="col-md-3">
                    <label class="form-label">Fecha Inicio</label>
                    <InputDate class="form-control" @bind-Value="itemActual.FechaInicio" />
                </div>

                <div class="col-md-3">
                    <label class="form-label">Fecha Fin Prevista</label>
                    <InputDate class="form-control" @bind-Value="itemActual.FechaFinPrevista" />
                </div>

                <div class="col-md-3">
                    <label class="form-label">Prioridad (1 a 5)</label>
                    <InputNumber class="form-control" @bind-Value="itemActual.Prioridad" />
                    <ValidationMessage For="@(() => itemActual.Prioridad)" />
                </div>

                <div class="col-md-3">
                    <label class="form-label">% Avance (0 a 100)</label>
                    <InputNumber class="form-control" @bind-Value="itemActual.PorcentajeAvance" />
                    <ValidationMessage For="@(() => itemActual.PorcentajeAvance)" />
                </div>
            </div>

            <div class="mt-4 d-flex flex-wrap gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save me-1"></i>@textoBotonGuardar
                </button>
                <button type="button" class="btn btn-warning" @onclick="ActualizarItem" disabled="@(!existeItem)">
                    <i class="bi bi-pencil-square me-1"></i>Actualizar
                </button>
                <button type="button" class="btn btn-danger" @onclick="ConfirmarEliminar" disabled="@(!existeItem)">
                    <i class="bi bi-trash3 me-1"></i>Eliminar
                </button>
            </div>
        </EditForm>
    </div>
</div>

<div class="mt-4">
    @if (cargando)
    {
        <div class="text-center">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">Cargando registros...</p>
        </div>
    }
    else if (listaItems.Count == 0)
    {
        <p class="text-muted">No hay registros disponibles.</p>
    }
    else
    {
        <div class="row row-cols-1 row-cols-md-2 g-3">
            @foreach (var i in listaItems)
            {
                <div class="col">
                    <div class="card h-100 border-light shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-check2-circle me-2 text-success"></i>@i.Titulo</h5>
                            <p class="card-text small text-muted">@i.Descripcion</p>
                            <ul class="list-unstyled mb-3">
                                <li><i class="bi bi-flag me-1 text-primary"></i> Entregable: <strong>@i.IdEntregable</strong></li>
                                <li><i class="bi bi-calendar-event me-1 text-primary"></i> Inicio: @i.FechaInicio?.ToString("yyyy-MM-dd")</li>
                                <li><i class="bi bi-calendar-check me-1 text-primary"></i> Fin Prevista: @i.FechaFinPrevista?.ToString("yyyy-MM-dd")</li>
                                <li><i class="bi bi-graph-up me-1 text-primary"></i> Avance: <strong>@i.PorcentajeAvance %</strong></li>
                            </ul>
                            <button class="btn btn-sm btn-outline-primary" @onclick="@(() => CargarEnFormulario(i))">
                                <i class="bi bi-upload"></i> Cargar
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

</div>

@code {
private List<Actividad> listaItems = new();
[SupplyParameterFromForm]
private Actividad itemActual { get; set; } = new();

private int idBusqueda { get; set; }
private bool existeItem = false;
private string textoBotonGuardar = "Crear";
private string mensaje = "";
private string claseAviso = "alert alert-info";
private bool cargando = false;

private const string urlBaseApi = "api/Actividad";

protected override async Task OnInitializedAsync()
{
    await CargarItems();
}

private async Task CargarItems()
{
    try
    {
        cargando = true;
        var cliente = fabricaHttp.CreateClient("ApiActividad");
        var respuesta = await cliente.GetFromJsonAsync<RespuestaApi<List<Actividad>>>(urlBaseApi);
        listaItems = respuesta?.Datos ?? new();
        mensaje = $"Se cargaron {listaItems.Count} registro(s).";
        claseAviso = "alert alert-success";
    }
    catch (Exception ex)
    {
        mensaje = $"Error al listar: {ex.Message}";
        claseAviso = "alert alert-danger";
    }
    finally { cargando = false; }
}

private async Task BuscarPorId()
{
    if (idBusqueda == 0)
    {
        mensaje = "Debe indicar un ID válido.";
        claseAviso = "alert alert-warning";
        return;
    }

    try
    {
        var cliente = fabricaHttp.CreateClient("ApiActividad");
        var ruta = $"{urlBaseApi}/id/{idBusqueda}";
        var respuesta = await cliente.GetFromJsonAsync<RespuestaApi<List<Actividad>>>(ruta);

        if (respuesta?.Datos is null || !respuesta.Datos.Any())
        {
            mensaje = $"No se encontró una actividad con ID {idBusqueda}.";
            claseAviso = "alert alert-warning";
            existeItem = false;
            textoBotonGuardar = "Crear";
            itemActual = new Actividad();
            return;
        }

        itemActual = respuesta.Datos.First();
        existeItem = true;
        textoBotonGuardar = "Actualizar";
        mensaje = "Actividad cargada.";
        claseAviso = "alert alert-success";
    }
    catch (Exception ex)
    {
        mensaje = $"Error al buscar: {ex.Message}";
        claseAviso = "alert alert-danger";
    }
}

private async Task GuardarSegunEstado()
{
    if (existeItem)
        await ActualizarItem();
    else
        await CrearItem();
}

private async Task CrearItem()
{
    try
    {
        var cliente = fabricaHttp.CreateClient("ApiActividad");
        var resp = await cliente.PostAsJsonAsync(urlBaseApi, itemActual);

        if (resp.IsSuccessStatusCode)
        {
            mensaje = "Actividad creada correctamente.";
            claseAviso = "alert alert-success";
            await CargarItems();
            LimpiarFormulario();
        }
        else
        {
            mensaje = $"No se pudo crear. Detalle: {await resp.Content.ReadAsStringAsync()}";
            claseAviso = "alert alert-danger";
        }
    }
    catch (Exception ex)
    {
        mensaje = $"Error al crear: {ex.Message}";
        claseAviso = "alert alert-danger";
    }
}

private async Task ActualizarItem()
{
    try
    {
        var cliente = fabricaHttp.CreateClient("ApiActividad");
        var ruta = $"{urlBaseApi}/id/{itemActual.Id}";
        var resp = await cliente.PutAsJsonAsync(ruta, itemActual);

        if (resp.IsSuccessStatusCode)
        {
            mensaje = "Actividad actualizada correctamente.";
            claseAviso = "alert alert-success";
            await CargarItems();
        }
        else
        {
            mensaje = $"No se pudo actualizar. Detalle: {await resp.Content.ReadAsStringAsync()}";
            claseAviso = "alert alert-danger";
        }
    }
    catch (Exception ex)
    {
        mensaje = $"Error al actualizar: {ex.Message}";
        claseAviso = "alert alert-danger";
    }
}

private async Task ConfirmarEliminar()
{
    bool confirmado = await JS.InvokeAsync<bool>("confirm", $"¿Seguro que desea eliminar la actividad con ID {itemActual.Id}?");
    if (confirmado)
        await EliminarItem();
}

private async Task EliminarItem()
{
    if (itemActual.Id == 0)
    {
        mensaje = "Debe indicar un ID válido.";
        claseAviso = "alert alert-warning";
        return;
    }

    try
    {
        var cliente = fabricaHttp.CreateClient("ApiActividad");
        var ruta = $"{urlBaseApi}/id/{itemActual.Id}";
        var resp = await cliente.DeleteAsync(ruta);

        if (resp.IsSuccessStatusCode)
        {
            mensaje = "Actividad eliminada.";
            claseAviso = "alert alert-success";
            await CargarItems();
            LimpiarFormulario();
        }
        else
        {
            mensaje = $"No se pudo eliminar. Detalle: {await resp.Content.ReadAsStringAsync()}";
            claseAviso = "alert alert-danger";
        }
    }
    catch (Exception ex)
    {
        mensaje = $"Error al eliminar: {ex.Message}";
        claseAviso = "alert alert-danger";
    }
}

private async Task ProbarConexion()
{
    try
    {
        var cliente = fabricaHttp.CreateClient("ApiActividad");
        var resp = await cliente.GetAsync(urlBaseApi);
        mensaje = resp.IsSuccessStatusCode ? "Conexión OK." : $"Respuesta {(int)resp.StatusCode}";
        claseAviso = resp.IsSuccessStatusCode ? "alert alert-success" : "alert alert-warning";
    }
    catch (Exception ex)
    {
        mensaje = $"Error de conexión: {ex.Message}";
        claseAviso = "alert alert-danger";
    }
}

private void CargarEnFormulario(Actividad i)
{
    itemActual = new Actividad
    {
        Id = i.Id,
        IdEntregable = i.IdEntregable,
        Titulo = i.Titulo,
        Descripcion = i.Descripcion,
        FechaInicio = i.FechaInicio,
        FechaFinPrevista = i.FechaFinPrevista,
        Prioridad = i.Prioridad,
        PorcentajeAvance = i.PorcentajeAvance
    };
    existeItem = true;
    textoBotonGuardar = "Actualizar";
    mensaje = "Registro cargado desde listado.";
    claseAviso = "alert alert-info";
}

private void LimpiarFormulario()
{
    itemActual = new Actividad();
    existeItem = false;
    textoBotonGuardar = "Crear";
    mensaje = "";
    claseAviso = "alert alert-info";
}


}