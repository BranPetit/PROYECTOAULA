@page "/Archivo_Entregables"
@using System.Net.Http.Json
@using System.ComponentModel.DataAnnotations
@using FrontendBlazorApi.Models
@inject IHttpClientFactory fabricaHttp
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>Gestión de Archivos - Entregables</PageTitle>

<div class="container mt-4">
    <div class="card shadow-sm border-0">
        <div class="card-header bg-primary text-white d-flex align-items-center justify-content-between">
            <h4 class="mb-0"><i class="bi bi-folder2-open me-2"></i>Gestión de Archivos - Entregables</h4>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-light btn-sm" @onclick="ProbarConexion" title="Probar conexión">
                    <i class="bi bi-wifi"></i>
                </button>
                <button class="btn btn-outline-light btn-sm" @onclick="CargarItems" title="Mostrar todos">
                    <i class="bi bi-list-ul"></i>
                </button>
                <button class="btn btn-outline-light btn-sm" @onclick="LimpiarFormulario" title="Limpiar formulario">
                    <i class="bi bi-eraser"></i>
                </button>
            </div>
        </div>

        <div class="card-body">
            <!-- Buscadores -->
            <div class="row mb-3 g-2">
                <div class="col-md-5">
                    <InputNumber class="form-control" placeholder="Ingrese ID de Archivo" @bind-Value="idArchivoBusqueda" />
                </div>
                <div class="col-md-5">
                    <InputNumber class="form-control" placeholder="Ingrese ID de Entregable" @bind-Value="idEntregableBusqueda" />
                </div>
                <div class="col-md-2 d-grid">
                    <button class="btn btn-outline-secondary" @onclick="BuscarPorIds">
                        <i class="bi bi-search"></i> Buscar
                    </button>
                </div>
            </div>

            <!-- Mensajes -->
            @if (!string.IsNullOrWhiteSpace(mensaje))
            {
                <div class="@claseAviso" role="alert">@mensaje</div>
            }

            <!-- Formulario -->
            <EditForm Model="itemActual" OnValidSubmit="GuardarSegunEstado">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Id Archivo *</label>
                        <InputNumber class="form-control" @bind-Value="itemActual.IdArchivo" />
                        <ValidationMessage For="@(() => itemActual.IdArchivo)" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Id Entregable *</label>
                        <InputNumber class="form-control" @bind-Value="itemActual.IdEntregable" />
                        <ValidationMessage For="@(() => itemActual.IdEntregable)" />
                    </div>
                </div>

                <div class="mt-4 d-flex flex-wrap gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> @textoBotonGuardar
                    </button>
                    <button type="button" class="btn btn-warning" @onclick="ActualizarItem" disabled="@(!existeItem)">
                        <i class="bi bi-pencil-square"></i> Actualizar
                    </button>
                    <button type="button" class="btn btn-danger" @onclick="ConfirmarEliminar" disabled="@(!existeItem)">
                        <i class="bi bi-trash"></i> Eliminar
                    </button>
                </div>
            </EditForm>
        </div>
    </div>

    <hr class="my-4" />

    <!-- Listado -->
    <div class="card shadow-sm border-0">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="bi bi-collection me-2"></i>Registros existentes</h5>
        </div>

        <div class="card-body">
            @if (cargando)
            {
                <p><em>Cargando registros...</em></p>
            }
            else if (listaItems.Count == 0)
            {
                <p>No hay registros disponibles.</p>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-secondary">
                            <tr>
                                <th>Id Archivo</th>
                                <th>Id Entregable</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var i in listaItems)
                            {
                                <tr>
                                    <td>@i.IdArchivo</td>
                                    <td>@i.IdEntregable</td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-outline-primary" title="Cargar"
                                                @onclick="@(() => CargarEnFormulario(i))">
                                            <i class="bi bi-arrow-up-square"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private List<Archivo_Entregable> listaItems = new();
    private Archivo_Entregable itemActual { get; set; } = new();

    private int idArchivoBusqueda { get; set; }
    private int idEntregableBusqueda { get; set; }
    private bool existeItem = false;
    private string textoBotonGuardar = "Crear";
    private string mensaje = "";
    private string claseAviso = "alert alert-info";
    private bool cargando = false;

    private const string urlBaseApi = "api/Archivo_Entregable";

    protected override async Task OnInitializedAsync()
    {
        await CargarItems();
    }

    private async Task CargarItems()
    {
        try
        {
            cargando = true;
            var cliente = fabricaHttp.CreateClient("ApiArchivo_Entregable");
            var respuesta = await cliente.GetFromJsonAsync<RespuestaApi<List<Archivo_Entregable>>>(urlBaseApi);
            listaItems = respuesta?.Datos ?? new();
            mensaje = $"Se cargaron {listaItems.Count} registro(s).";
            claseAviso = "alert alert-success";
        }
        catch (Exception ex)
        {
            mensaje = $"Error al listar: {ex.Message}";
            claseAviso = "alert alert-danger";
        }
        finally { cargando = false; }
    }

    private async Task BuscarPorIds()
    {
        if (idArchivoBusqueda == 0 || idEntregableBusqueda == 0)
        {
            mensaje = "Debe indicar ambos IDs válidos.";
            claseAviso = "alert alert-warning";
            return;
        }

        try
        {
            var cliente = fabricaHttp.CreateClient("ApiArchivo_Entregable");
            var ruta = $"{urlBaseApi}/id/{idArchivoBusqueda}/{idEntregableBusqueda}";
            var respuesta = await cliente.GetFromJsonAsync<RespuestaApi<Archivo_Entregable>>(ruta);

            if (respuesta?.Datos is null)
            {
                mensaje = $"No se encontró un registro con Archivo {idArchivoBusqueda} y Entregable {idEntregableBusqueda}.";
                claseAviso = "alert alert-warning";
                existeItem = false;
                textoBotonGuardar = "Crear";
                itemActual = new Archivo_Entregable();
                return;
            }

            itemActual = respuesta.Datos;
            existeItem = true;
            textoBotonGuardar = "Actualizar";
            mensaje = "Registro cargado.";
            claseAviso = "alert alert-success";
        }
        catch (Exception ex)
        {
            mensaje = $"Error al buscar: {ex.Message}";
            claseAviso = "alert alert-danger";
        }
    }

    private async Task GuardarSegunEstado()
    {
        if (existeItem)
            await ActualizarItem();
        else
            await CrearItem();
    }

    private async Task CrearItem()
    {
        try
        {
            var cliente = fabricaHttp.CreateClient("ApiArchivo_Entregable");
            var resp = await cliente.PostAsJsonAsync(urlBaseApi, itemActual);

            if (resp.IsSuccessStatusCode)
            {
                mensaje = "Registro creado correctamente.";
                claseAviso = "alert alert-success";
                await CargarItems();
                LimpiarFormulario();
            }
            else
            {
                mensaje = $"No se pudo crear. Detalle: {await resp.Content.ReadAsStringAsync()}";
                claseAviso = "alert alert-danger";
            }
        }
        catch (Exception ex)
        {
            mensaje = $"Error al crear: {ex.Message}";
            claseAviso = "alert alert-danger";
        }
    }

    private async Task ActualizarItem()
    {
        try
        {
            var cliente = fabricaHttp.CreateClient("ApiArchivo_Entregable");
            var ruta = $"{urlBaseApi}/id/{itemActual.IdArchivo}/{itemActual.IdEntregable}";
            var resp = await cliente.PutAsJsonAsync(ruta, itemActual);

            if (resp.IsSuccessStatusCode)
            {
                mensaje = "Registro actualizado correctamente.";
                claseAviso = "alert alert-success";
                await CargarItems();
            }
            else
            {
                mensaje = $"No se pudo actualizar. Detalle: {await resp.Content.ReadAsStringAsync()}";
                claseAviso = "alert alert-danger";
            }
        }
        catch (Exception ex)
        {
            mensaje = $"Error al actualizar: {ex.Message}";
            claseAviso = "alert alert-danger";
        }
    }

    private async Task ConfirmarEliminar()
    {
        bool confirmado = await JS.InvokeAsync<bool>("confirm",
            $"¿Seguro que desea eliminar el registro con Archivo {itemActual.IdArchivo} y Entregable {itemActual.IdEntregable}?");
        if (confirmado)
            await EliminarItem();
    }

    private async Task EliminarItem()
    {
        if (itemActual.IdArchivo == 0 || itemActual.IdEntregable == 0)
        {
            mensaje = "Debe indicar IDs válidos.";
            claseAviso = "alert alert-warning";
            return;
        }

        try
        {
            var cliente = fabricaHttp.CreateClient("ApiArchivo_Entregable");
            var ruta = $"{urlBaseApi}/id/{itemActual.IdArchivo}/{itemActual.IdEntregable}";
            var resp = await cliente.DeleteAsync(ruta);

            if (resp.IsSuccessStatusCode)
            {
                mensaje = "Registro eliminado.";
                claseAviso = "alert alert-success";
                await CargarItems();
                LimpiarFormulario();
            }
            else
            {
                mensaje = $"No se pudo eliminar. Detalle: {await resp.Content.ReadAsStringAsync()}";
                claseAviso = "alert alert-danger";
            }
        }
        catch (Exception ex)
        {
            mensaje = $"Error al eliminar: {ex.Message}";
            claseAviso = "alert alert-danger";
        }
    }

    private async Task ProbarConexion()
    {
        try
        {
            var cliente = fabricaHttp.CreateClient("ApiArchivo_Entregable");
            var resp = await cliente.GetAsync(urlBaseApi);
            mensaje = resp.IsSuccessStatusCode ? "Conexión OK." : $"Respuesta {(int)resp.StatusCode}";
            claseAviso = resp.IsSuccessStatusCode ? "alert alert-success" : "alert alert-warning";
        }
        catch (Exception ex)
        {
            mensaje = $"Error de conexión: {ex.Message}";
            claseAviso = "alert alert-danger";
        }
    }

    private void CargarEnFormulario(Archivo_Entregable i)
    {
        itemActual = new Archivo_Entregable
        {
            IdArchivo = i.IdArchivo,
            IdEntregable = i.IdEntregable
        };
        existeItem = true;
        textoBotonGuardar = "Actualizar";
        mensaje = "Registro cargado desde listado.";
        claseAviso = "alert alert-info";
    }

    private void LimpiarFormulario()
    {
        itemActual = new Archivo_Entregable();
        existeItem = false;
        textoBotonGuardar = "Crear";
        mensaje = "";
        claseAviso = "alert alert-info";
    }
}
